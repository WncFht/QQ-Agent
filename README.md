# QQ Agent

QQ Agent是一个基于NcatBot框架的QQ机器人，提供多种实用功能，包括链接管理、对联生成和表白功能。
后续会接入 RAG 功能以及 tool 功能，实现更加智能的对话和信息检索。

## 安装与运行

### 环境要求

- Python 3.8+
- 安装了[napcat](https://github.com/napcat/napcat)服务端

### 安装步骤

1. 克隆仓库到本地：

```bash
git clone https://github.com/WncFht/QQ-Agent/tree/main
cd QQ-Agent
```

2. 创建并激活虚拟环境（可选但推荐）：

```bash
# 使用venv
python -m venv venv
# Windows激活
venv\Scripts\activate
# Linux/Mac激活
source venv/bin/activate
```

3. 安装依赖：

```bash
pip install -r requirements.txt
```

4. 配置机器人：

编辑`bot/main.py`文件，设置以下配置项：

```python
CONFIG = {
    "ws_uri": "ws://localhost:3001",  # napcat服务器地址
    "admin_qq": ["你的QQ号"],  # 管理员QQ号列表
    "bot_qq": "机器人QQ号",  # 机器人QQ号
}
```

5. 运行机器人：

```bash
python main.py
```

### 插件说明

NapcatBot支持以下插件：

1. **LinkManager** - 链接管理插件
   - 添加、查看和搜索链接
   - 链接有效性检查
   - 群组隔离

2. **CoupletPlugin** - 对联插件
   - 生成对联下联
   - 随机对联生成

3. **DeclarationPlugin** - 表白插件
   - 生成随机表白语句
   - 指定表白对象

### 使用方法

#### 链接管理

```
/add <链接URL> [-d 描述] [-t 标签1,标签2] [-a|-u] - 添加或更新链接
/view <链接URL> - 查看链接详情
/search <关键词> [-t 标签] - 搜索链接
/check_links - 手动检查链接有效性
```

#### 对联功能

```
对联 <上联> - 生成对应的下联
对对联 <上联> - 随机生成对应的下联
```

#### 表白功能

```
表白 <对象> - 向指定对象表白
```

#### 通用命令

```
/help - 查看所有可用指令
网站 - 获取技术分享网站链接
公告 - 查看群公告
```

## 链接管理系统

这是一个协作式的链接管理系统，允许多个用户共同维护和丰富链接资源。每个链接可以有多个用户的描述，并且支持标签系统进行分类。系统实现了严格的群组隔离，确保每个群只能访问其自己的链接资源。

### 基本概念

1. **链接**：每个链接都有一个创建者，创建时间，以及可选的标签和描述。同时包含链接状态信息，包括有效性检查结果和最后检查时间。
2. **描述**：每个用户可以为链接添加一个描述，描述包含内容、作者和时间戳。
3. **标签**：链接可以有多个标签，所有用户都可以为链接添加新标签。
4. **群组隔离**：每个链接都属于特定的群组，只能在该群组内访问和管理。
5. **链接状态**：系统会定期检查链接的有效性，并在链接失效时通知创建者。
6. **权限**：
   - 所有用户都可以添加新链接
   - 用户只能编辑/更新自己的描述
   - 所有用户都可以为任何链接添加标签
   - 所有用户都可以查看本群内任何链接的完整信息
   - 链接仅在其所属群组内可见

### 命令列表

#### 1. 添加或更新链接 (/add)

支持以下功能：

1. 基本添加链接：
```
/add <链接URL>
```

2. 添加链接和描述：
```
/add <链接URL> -d "这是一个描述"
```

3. 添加链接、描述和标签：
```
/add <链接URL> -d "这是一个描述" -t "标签1,标签2,标签3"
```

4. 追加新的描述（作为新用户）：
```
/add <链接URL> -d "新的描述" -a
```

5. 更新自己的描述：
```
/add <链接URL> -d "更新的描述" -u
```

参数说明：
- `-d` 或 `--desc`: 添加描述
- `-t` 或 `--tags`: 添加标签（用逗号分隔）
- `-a` 或 `--append`: 作为新用户添加描述
- `-u` 或 `--update`: 更新自己的已有描述

注意事项：
- `-a` 和 `-u` 是互斥的，不能同时使用
- 使用 `-u` 时，必须是之前添加过描述的用户
- 不使用任何参数时，默认会更新用户已有的描述，或作为新描述添加

#### 2. 查看链接详情 (/view)

查看链接的完整信息：
```
/view <链接URL>
```

返回信息包括：
- 链接URL
- 创建者信息
- 创建时间
- 所有标签
- 所有用户的描述（按时间顺序）

示例输出：
```
链接详情：
URL: https://example.com
创建者: 用户A
创建时间: 2024-03-11 23:00:04
标签: Python, 教程, 技术
状态: 失效
失效时间: 2024-03-12 10:00:00
原因: HTTP状态码: 404

描述列表：
1. 用户A (2024-03-11 23:00:04):
   这是一个很好的Python教程网站
2. 用户B (2024-03-11 23:05:04):
   特别推荐它的异步编程部分
3. 用户C (2024-03-12 10:00:00):
   代码示例非常清晰
```

#### 3. 搜索链接 (/search)

支持以下功能：

1. 基本关键词搜索：
```
/search <关键词>
```

2. 按标签搜索：
```
/search <关键词> -t <标签>
```

搜索结果示例：
```
- https://example.com [标签: 技术, 教程]
  描述 (用户1): 这是第一个描述
  描述 (用户2): 这是追加的描述

- https://another-example.com [标签: 博客]
  描述 (用户3): 这是一个技术博客
```

### 数据结构

链接在JSON文件中的存储格式：
```json
{
    "url": "https://example.com",
    "group_id": "1234567890",
    "creator_id": "2130212584",
    "creator_name": "创建者",
    "created_at": "2024-03-11 23:00:04",
    "last_checked": "2024-03-11 23:30:00",
    "is_valid": true,
    "status_message": "HTTP状态码: 200",
    "invalid_since": null,
    "tags": ["技术", "教程", "Python"],
    "descriptions": [
        {
            "content": "这是第一个描述",
            "user_id": "2130212584",
            "username": "用户1",
            "timestamp": "2024-03-11 23:00:04"
        },
        {
            "content": "这是另一个用户的描述",
            "user_id": "3456789012",
            "username": "用户2",
            "timestamp": "2024-03-11 23:05:04"
        }
    ]
}
```

### 链接有效性检查

系统会自动进行以下操作：

1. **定期检查**：每隔一小时自动检查所有链接的可访问性。
2. **状态更新**：
   - 记录最后检查时间
   - 更新链接状态（有效/无效）
   - 记录状态信息（HTTP状态码或错误信息）
   - 记录失效时间（如果链接失效）
3. **失效通知**：当链接失效时，系统会自动通过私信通知链接创建者。

查看链接时（使用`/view`命令）会显示链接的状态信息：
```
链接详情：
URL: https://example.com
创建者: 用户A
创建时间: 2024-03-11 23:00:04
标签: Python, 教程, 技术
状态: 失效
失效时间: 2024-03-12 10:00:00
原因: HTTP状态码: 404

描述列表：
1. 用户A (2024-03-11 23:00:04):
   这是一个很好的Python教程网站
```

### 其他命令

#### 网站命令
对于 "网站" 回复 https://wncfht.github.io/Awesome-Tech-Share/

#### 公告命令
对于 "公告" 回复
```
1. 写文章、笔记、想法等等/分享资料
2. 总结主要内容，提取两三个关键词，附上链接发在群里，要求是便于他人查询即可。每周群主/管理员会同一收集更新到网站上
3.另外聊天讨论技术分享比较好的可以@群主/管理员收录

每周更新后会统一@所有人查看最新的提交记录
```

#### 帮助命令
使用 `/help` 查看所有可用指令及其用法说明。

### 欢迎功能

当新用户进群时，机器人会发送欢迎消息：
```
欢迎你进入群聊！🎉🎉🎉

我是该群的机器人助手，这是我的使用帮助:

/help 查看所有可用指令
/add 添加链接
/search 搜索链接
```

## 待实现功能清单

### 1. 链接管理增强
- [ ] 链接有效性检查
  - 定期检查链接是否可访问
  - 标记失效链接
  - 自动通知创建者链接失效

### 3. 群组功能增强
- [ ] 群组管理功能
  - 管理员可以编辑/删除任何链接
  - 批量导入/导出功能
  - 定期数据备份

### 4. 数据分析与报告
- [ ] 定期报告
  - 每日/周/月精选链接

### 5. 高级功能
- [ ] 链接内容预览
  - 自动提取网页标题和描述
  - 生成网页预览图
  - 显示网页favicon
- [ ] 智能标签推荐
  - 基于链接内容自动推荐标签
  - 相似标签合并建议
  - 标签规范化
- [ ] 搜索增强
  - 支持高级搜索语法
  - 搜索结果排序选项
  - 搜索历史记录

